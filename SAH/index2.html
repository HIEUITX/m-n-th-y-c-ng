<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Web B - G·ª≠i file & Nh·∫≠n file</title>
  <style>
    body { font-family: Arial; padding: 20px; max-width: 500px; margin: auto; }
    button, input { margin-top: 10px; width: 100%; padding: 10px; }
    #status, #fileHash, #receiveInfo, #checkResult { margin-top: 10px; font-family: monospace; }
    a.downloadLink { display: inline-block; margin-top: 10px; padding: 10px; background: #2980b9; color: white; text-decoration: none; border-radius: 5px; }
  </style>
</head>
<body>
  <h2>Web B - G·ª≠i file & Nh·∫≠n file</h2>
  <input type="file" id="fileInput" />
  <button id="sendBtn">üì§ G·ª≠i file</button>
  <div id="status">Ch∆∞a g·ª≠i file</div>
  <div id="fileHash"></div>
  <hr />
  <h3>Nh·∫≠n file t·ª´ Web A</h3>
  <div id="receiveInfo">Ch∆∞a nh·∫≠n file</div>
  <div id="fileHashReceive"></div>
  <div id="checkResult"></div>
  <div id="downloadLinks"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script>
    const ws = new WebSocket("ws://localhost:8080");

    const fileInput = document.getElementById("fileInput");
    const sendBtn = document.getElementById("sendBtn");
    const status = document.getElementById("status");
    const fileHashDiv = document.getElementById("fileHash");

    const receiveInfo = document.getElementById("receiveInfo");
    const fileHashReceive = document.getElementById("fileHashReceive");
    const checkResult = document.getElementById("checkResult");
    const downloadLinks = document.getElementById("downloadLinks");

    ws.onopen = () => {
      status.textContent = "‚úÖ ƒê√£ k·∫øt n·ªëi WebSocket. ƒêƒÉng k√Ω l√† Web B...";
      ws.send(JSON.stringify({action: "register", role: "B"}));
    };

    ws.onerror = () => {
      status.textContent = "‚ùå L·ªói k·∫øt n·ªëi WebSocket.";
    };

    ws.onmessage = event => {
      const data = JSON.parse(event.data);

      if(data.status === "registered" && data.role === "B") {
        status.textContent = "‚úÖ ƒêƒÉng k√Ω th√†nh c√¥ng v·ªõi server.";
      }

      if(data.status === "file_received") {
        status.textContent = "‚úÖ Server ƒë√£ nh·∫≠n file.";
      }

      if(data.status === "file_from_A") {
        const filename = data.filename;
        const fileHashSent = data.fileHash;
        const base64Data = data.fileData;

        receiveInfo.textContent = `üì• ƒê√£ nh·∫≠n file: ${filename}`;
       

        // Gi·∫£i m√£ base64 th√†nh Uint8Array
        const binaryStr = atob(base64Data);
        const len = binaryStr.length;
        const bytes = new Uint8Array(len);
        for(let i=0; i<len; i++) {
          bytes[i] = binaryStr.charCodeAt(i);
        }

        // T√≠nh l·∫°i hash
        const wordArray = CryptoJS.lib.WordArray.create(bytes);
        const hash = CryptoJS.SHA256(wordArray).toString();

        if(hash === fileHashSent) {
          checkResult.style.color = "limegreen";
          checkResult.textContent = "‚úîÔ∏è T√≠nh to√†n v·∫πn d·ªØ li·ªáu ƒë√∫ng!";
        } else {
          checkResult.style.color = "red";
          checkResult.textContent = "‚ùå D·ªØ li·ªáu b·ªã thay ƒë·ªïi!";
        }

        // T·∫°o link t·∫£i file
        const blob = new Blob([bytes]);
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        a.textContent = "‚¨áÔ∏è T·∫£i file " + filename;
        a.className = "downloadLink";

        downloadLinks.innerHTML = "";
        downloadLinks.appendChild(a);
      }
    };

    sendBtn.onclick = () => {
      const file = fileInput.files[0];
      if(!file) {
        alert("Ch·ªçn file tr∆∞·ªõc ƒë√£!");
        return;
      }

      const reader = new FileReader();
      reader.onload = e => {
        const bytes = new Uint8Array(e.target.result);
        const wordArray = CryptoJS.lib.WordArray.create(bytes);
        const hash = CryptoJS.SHA256(wordArray).toString();

   

        // Base64 h√≥a d·ªØ li·ªáu
        let binary = '';
        for(let b of bytes) {
          binary += String.fromCharCode(b);
        }
        const base64Data = btoa(binary);

        // G·ª≠i d·ªØ li·ªáu l√™n server v·ªõi action send_file_B
        ws.send(JSON.stringify({
          action: "send_file_B",
          filename: file.name,
          fileData: base64Data,
          fileHash: hash
        }));

        status.textContent = "üì§ ƒêang g·ª≠i file...";
      };
      reader.readAsArrayBuffer(file);
    };
  </script>
</body>
</html>
